## Creating Test Fixtures

### Static fixtures

Here are some examples of how to use the fixture factories.

One article with a random title, as defined in the factory [on the previous page](factories.md):
```
$article = ArticleFactory::make()->getEntity();
``` 
Two articles with different random titles:
```
$articles = ArticleFactory::make(2)->getEntities();
``` 
One article with title set to 'Foo':
```
$article = ArticleFactory::make(['title' => 'Foo'])->getEntity();
``` 
Three articles with the title set to 'Foo':
```
$articles = ArticleFactory::make(['title' => 'Foo'], 3)->getEntities();
``` 

or

```
$articles = ArticleFactory::make(3)->patchData(['title' => 'Foo'])->getEntities();
```
 
or
 
```
$articles = ArticleFactory::make()->patchData(['title' => 'Foo'])->setTimes(3)->getEntities();
```

In order to persist the data generated, use the method `persist` instead of `getEntity` resp. `getEntities`:
```
$articles = ArticleFactory::make(3)->persist();
```

### Dynamic fixtures
The drawback of the previous example, is that, if you haven't defined the `title` field with `faker` in the `setDefaultTemplate` method,  all the generated examples have the same title. The following
generates three articles with different random titles:
```
use App\Test\Factory\ArticleFactory;
use Faker\Generator;
...
$articles = ArticleFactory::make(function(ArticleFactory $factory, Generator $faker) {
   return [
       'title' => $faker->text,
   ];
}, 3)->persist();
```

### Chaining methods
The aim of the test fixture factories is to bring business coherence in your test fixtures.
This can be simply achieved using the chainable methods of your factories. As long as those return `$this`, you may chain as much methods as you require.
In the following example, we make use of a method in the Article factory in order to easily create articles with a job title.
It is a simple study case, but this could be any pattern of your business logic. 
```
$articleFactory = ArticleFactory::make(['title' => 'Foo']);
$articleFoo1 = $articleFactory->persist();
$articleFoo2 = $articleFactory->persist();
$articleJobOffer = $articleFactory->setJobTitle()->persist();
```
 
 The two first articles have a title set two 'Foo'. The third one has a job title, which is randomly generated by fake, as defined in the
 `ArticleFactory`. 
 
 ### Populating associations: the _with_ method
 If you have baked your factories with the option `-m` or `--methods`, you will have noticed that a method for each association
 has been inserted in the factories. This will assist you creating fixtures for the associated models. For example, we can 
 create an article with 10 authors as follow:
 ```
use App\Test\Factory\ArticleFactory;
use App\Test\Factory\AuthorFactory;
use Faker\Generator;
...
 $article = ArticleFactory::make()->with('Authors', AuthorFactory::make(10))->persist();
```
or using the method defined in our `ArticleFactory`:
```
$article = ArticleFactory::make()->withAuthors(10)->persist();
```

If we wish to randomly populate the field `biography` of the 10 authors of our article, with 10 different biographies:
```
$article = ArticleFactory::make()->withAuthors(function(AuthorFactory $factory, Generator $faker) {
    return [
        'biography' => $faker->realText()
    ];
}, 10)->persist();
```
It is also possible to use the _dot_ notation to create associated fixtures:
```
$article = ArticleFactory::make()->with('Authors.Address.City.Country', ['name' => 'Kenya'])->persist();
```
will create an article, with an author having itself an address in Kenya.

The second parameter of the method with can be:
* an array of field and their values
* an integer: the number
* a factory

Ultimately, the square bracket notation provides a mean to specify the number of associated
data create:
```
$article = ArticleFactory::make(5)->with('Authors[3].Address.City.Country', ['name' => 'Kenya'])->persist();
```
will create 5 articles, having themselves each 3 different associated authors, all located in Kenya.
  
It is also possible to specify the fields of a toMany associated model.
For example, if we wish to create a random country with two cities having known names:

```
$country = CountryFactory::make()->with('Cities', [
    ['name' => 'Nairobi'],
    ['name' => 'Mombasa'],
])->persist();
```

This an be useful if your business logic uses hard coded values, or constants.